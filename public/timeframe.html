<html>
<head>
<script src="/assets/jquery.js"></script>
<link href="/jquery-ui-1.9.2/css/smoothness/jquery-ui-1.9.2.custom.css" rel="stylesheet">
<script type="text/javascript" src="/jquery-ui-1.9.2/js/jquery-ui-1.9.2.custom.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	
	$("td#dp2").hover(function() {
		$("#datepicker2").show();
	}, function() {
		$("#datepicker2").hide();//datepicker("destroy");
	});
	
	dragging = false;
	
	function defineDatepicker(selector) {
		var dp = $(selector).datepicker({
			inline: true
		});
		
		dp.mousedown(function(e){
			var a = $(selector + " .ui-state-hover");
			
			var td = a.parent();
			var is_day = (td.attr("data-handler") == "selectDay");

			if (is_day == true) {
				var day = parseInt(a.text());
				var month = td.attr("data-month");
				var year = td.attr("data-year");

				dragging = true;
				begin_date = new Date(year, month, day);
				// console.log("day_begin: " + begin);
			}
		});
		
		dp.selectable({
			stop: function(event, ui) {
				dragging = false;
				var a = $(selector +" .ui-state-hover");
				var td = a.parent();
				var is_day = (td.attr("data-handler") == "selectDay");

				if (is_day == true) {
					var day = a.text();
					var month = td.attr("data-month");
					var year = td.attr("data-year");

						console.log("END: " + day + "." + month + "." + year);
				}
			}
		});
	}
	
	function getDate(a) {
		var td = a.parent()

		var day = a.text();
		var month = td.attr("data-month");
		var year = td.attr("data-year");
		var date = new Date(year, month, day);
		return(date);
	}
	
	defineDatepicker("#datepicker");
	

	defineDatepicker("#datepicker2");
	var newDate = $("#datepicker").datepicker("getDate");
		newDate.setMonth(newDate.getMonth() + 1);
	$("#datepicker2").datepicker("setDate", newDate);
		
	$("td a").hover(function() {

		if (dragging == true) {
			var a = $(this);
			var hover_date = getDate(a)
			
			var all_anchors = $("td[data-handler=selectDay] a");
			all_anchors.each(function(i,e){
				console.log("internal loop");
				var a = $(this);
				var current_date = getDate(a);
				
				if (begin_date < hover_date) {
					var start = begin_date;
					var end = hover_date;
				} else {
					var start = hover_date;
					var end = begin_date;
				}
				
				// console.log(end);
				
				if ((start <= current_date) && (current_date <= end)) {
					a.parent().addClass("mySelected");
				} else {
					a.parent().removeClass("mySelected");
				}
			});
		} else {
			console.log("not dragging");
		}
	});
	
});
</script>
<style type="text/css">
td.mySelected a, td.mySelected a.ui-state-default, td.mySelected a.ui-selectee, td.mySelected a.ui-selected {
	background: #F2B272;
}
.ui-selectable-helper { border:0px; }
#dp2{
	width: 500px;
}
</style>
</head>
<body>
	<table>
		<tr>
			<td>
				<div id="datepicker"></div>
			</td>
			<td id="dp2">
				<div id="datepicker2"></div>
			</td>
		</tr>
	</table>
	<div id="dp_wrapper">
		
	</span>
</body>
</html>